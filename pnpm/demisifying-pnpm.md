---
author: Demistifying pnpm
---

# Demistifying pnpm

## Agenda

Things we'll talk about today

- What is pnpm?
- Why was it created?
- What makes pnpm great?
- Q&A

---

# What is pnpm

- An open source package manager for the javascript ecosystem
- `p`erformant `npm`
- Written in TypeScript
- Other tools in this space
  - `npm` (ï‚› GitHub i.e. Microsoft)
  - `yarn` (ï‚š Facebook)
  - `bower` (ï‚™ Twitter)

I asked GitHub Copilot who maintains pnpm and it said:

```
ï‘‚  â”â”â”â”â”â”â”â”

Who maintains pnpm?

ï’¸  â”â”â”â”â”â”â”â”

pnpm is maintained by Zoltan Kochan.

```

---

# Why do we have pnpm?

Before we talk about why `pnpm` is good, we first need to talk about the problems it set out to solve.

## Key terminology

### `package.json`:

  - A "manifest" file for a project
  - Specifies any metadata about the project (like it's name or it's version)
  - It also specifies any dependencies a project may have.

### `package-lock.json`:

  - Specific to the `npm` ecosystem, but it's role is common and many other tools have an equivalent.
  - Is automatically generated by the tool you're using to describe the _exact_ tree of dependencies that was generated/installed
  - `pnpm` generates a lock file is saved as `pnpm-lock.yaml`

### `node_modules/`: 

  - Directory where package managers install a project's dependencies
  - The directory structure is important and affects how `import` or `require` statements work

---

# Why do we have pnpm?

One common complaint when using `npm` is that `node_modules` are huge and take a while to install

## npm please

- Each `npm` project installs its own version of its dependencies
- Everytime you run `npm ci` every single dependency is fetched and unpacked
- `npm install`; nothing happens if nothing changed but deps might get updated
  - you can prevent it from changing the lockfile with `--no-save`
- If a dependency has its own set of dependencies, your project has access to them

## pnpm?

- Each `pnpm` project shares dependencies in a global store
- `pnpm install` nothing happens if nothing changed but can prevent deps from getting updated
  - using the flag `--frozen-lockfile`
  - if something did change, it will only install what changed (like, really)
- Your project only has access to deps in package.json, no transitive dependencies
  - unless you tell `pnpm` to expose them

---

# What makes pnpm great?

## npm `node_modules/`

- `npm` creates a "flat" node_modules structure
- Every dependency and transitive dependency is just installed right here

The structure of `node_modules` with `@socialtables/st-scripts` as the only dependency:
```bash
âœ tree npm_flat/node_modules -L 1 -a | head -n 15

npm_flat/node_modules
â”œâ”€â”€ .bin
â”œâ”€â”€ .package-lock.json
â”œâ”€â”€ @ampproject
â”œâ”€â”€ @babel
â”œâ”€â”€ @bcoe
â”œâ”€â”€ @blakeembrey
â”œâ”€â”€ @eslint
â”œâ”€â”€ @eslint-community
â”œâ”€â”€ @humanwhocodes
â”œâ”€â”€ @isaacs
â”œâ”€â”€ @istanbuljs
â”œâ”€â”€ @jest
â”œâ”€â”€ @jridgewell
â”œâ”€â”€ @nicolo-ribaudo
â”œâ”€â”€ ... about 560 more directories below
```

---

# What makes pnpm great?

## pnpm `node_modules/`

- **Hard links** dependencies in here from the files in the global store into `/.pnpm`
- Stores and sorts them based on the version of the package installed
- **Symlinks** directories from `/.pnpm` to the root of node_modules (controlling what you have access to)

The structure of `node_modules` with `@socialtables/st-scripts` as the only dependency:

```bash
âœ tree pnpm_nonflat/node_modules -L 1 -a | head -n 15

pnpm_nonflat/node_modules
â”œâ”€â”€ .bin
â”œâ”€â”€ .modules.yaml
â”œâ”€â”€ .pnpm
â”œâ”€â”€ @babel
â”œâ”€â”€ @eslint
â”œâ”€â”€ @eslint-community
â”œâ”€â”€ @nicolo-ribaudo
â”œâ”€â”€ @socialtables
â”œâ”€â”€ @types
â”œâ”€â”€ @typescript-eslint
â”œâ”€â”€ eslint
â”œâ”€â”€ eslint-config-prettier
â”œâ”€â”€ eslint-import-resolver-node
â”œâ”€â”€ eslint-import-resolver-webpack
â”œâ”€â”€ ... about 10 more directories below
```

---

# How does the file system work? (Unix-like FS, who uses Windows anymore)

## Key terminology

### Files

- Container in a computer for storing information
- When you create a file, an `inode` is created to hold metadata
- The file name is stored in a directory and `inodes` act as the "middleman" for the content

### Index Nodes

- A data structure that stores information about the file
- Contains attributes like size, permissions, timestamps
- It also contains the address of the data blocks in memory where the file content is stored

### Symbolic Link (or symlink)

- Is a pointer to another file on disk (e.g. "shortcuts" in Windows)
- It's a separate file with it's own `inode` that redirects to the original `inode`
- The actual content of a symlink is just a path that tells the file system where to find the original

### Hard Link

- Creates a new "label" for the original `inode`
- Both the original file and the hard link point to the same `inode`
- Changes made to the original file's content reflect in the hard link
- If the original file is renamed, deleted or moved the hard link is unchanged

---

# How does the file system work? (Unix-like FS, who uses Windows anymore)

A diagram to illustrate

```plaintext



â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     File      â”‚     â”‚     inode     â”‚     â”‚   Data Blocks  â”‚
â”‚  (file name)  â”‚ â”€â”€> â”‚  (metadata)   â”‚ â”€â”€> â”‚  (actual data) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        ^                     ^
        |                     |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Symlink     â”‚    â”‚   Hard Link   â”‚
â”‚  (file path)  â”‚    â”‚  (file name)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
---

# What makes pnpm great?

## Content Addressable Store

- When you install a new version of a dependency, only the changed files are stored in the store
- Files that have not changed are reused
- All pnpm projects on the same machine look up dependencies from this same store
- A dependency is only ever really installed once

```plaintext
âœ cd ~/.pnpm-store

âœ tree -L 5 | head -n 6

.
â””â”€â”€ v3
    â”œâ”€â”€ files
    â”‚Â Â  â”œâ”€â”€ 00
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00cc06fe80fe136b07a2bcc0829446f57762adb43bc05d667ada3fcd8e4bbece2847684cfea95a01e30db9c3868cc3c106c118513973c630b7a64aeec274c7
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 038635bd30118416b0faedbfe7a1d1fe5b8b2a5e9428fff0cbf19af90c81fa1f82760118ce4af3f49a0d3b4be5e0b59f916582db6a8acc54822cf0e0e1c21e
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 041f29e977545e325337a4be578ec84903aebe02b066f0e1a2fdf07f6efc909015164a93b3ad15323fad9662f054186e878fc47f354279455535dbf0c92f74
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 0453ee04cfec4f7e5cba7dc66afbc31b870edd24403d1e1fcb694e8c3c7cd5019b0ba04e57c4c4f0d358886d8cfba709e05619f45cbb6d1f89031a3acbc4a8
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 04d4c908c20727c1561aa476dd7a5b7c9d8ccc0a8d5cf3dc7dff65b3870ee4b7a4339ebc0f8206558d76a4cc56ff8cadd4ca108c5299671b48b13c6dfbca4d
```

---

# What makes pnpm great?

## Content Addressable Store

Example of content:

```bash
âœ cat v3/files/09/f48a6b2304e659cf84101be90030b443137260...'long hash continues'

import buildFormatLongFn from "../../../_lib/buildFormatLongFn/index.js";
var dateFormats = {
  full: 'EEEE, d. MMMM yyyy',
  long: 'd. MMMM yyyy',
  medium: 'd. M. yyyy',
  short: 'dd.MM.yyyy'
};
var timeFormats = {
  full: 'H:mm:ss zzzz',
  long: 'H:mm:ss z',
  medium: 'H:mm:ss',
  short: 'H:mm'
};
var dateTimeFormats = {
  full: "{{date}} 'v' {{time}}",
  long: "{{date}} 'v' {{time}}",
  medium: '{{date}}, {{time}}',
  short: '{{date}}, {{time}}'
};
```

---

# What makes pnpm great?

## Symlinked node_modules structure

Scenario: you installed `foo@1.0.0` and foo depends on `bar@1.0.0`

### Phase 1 - Grab files from store
```plaintext
node_modules
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â””â”€â”€ foo -> <store>/foo
                â”œâ”€â”€ index.js
                â””â”€â”€ package.json
```

---

# What makes pnpm great?

## Symlinked node_modules structure

Scenario: you installed `foo@1.0.0` and foo depends on `bar@1.0.0`

### Phase 2 - Link transitive dependencies together

```plaintext
node_modules
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â”œâ”€â”€ foo -> <store>/foo
            â””â”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
```

---

# What makes pnpm great?

## Symlinked node_modules structure

Scenario: you installed `foo@1.0.0` and foo depends on `bar@1.0.0`

### Phase 3 - Link direct dependencies

```plaintext
node_modules
â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â”œâ”€â”€ foo -> <store>/foo
            â””â”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
```

---

# What makes pnpm great?

## Symlinked node_modules structure

Scenario: you installed `foo@1.0.0` and foo depends on `bar@1.0.0`

### Curve Ball - Adding a new transitive dependency

Let's add `qar@2.0.0` as a dependency of BOTH foo and bar. So `foo > bar > qar` and `foo > qar`

```plaintext
node_modules
â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â”œâ”€â”€ bar -> <store>/bar
    â”‚       â””â”€â”€ qar -> ../../qar@2.0.0/node_modules/qar
    â”œâ”€â”€ foo@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â”œâ”€â”€ foo -> <store>/foo
    â”‚       â”œâ”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
    â”‚       â””â”€â”€ qar -> ../../qar@2.0.0/node_modules/qar
    â””â”€â”€ qar@2.0.0
        â””â”€â”€ node_modules
            â””â”€â”€ qar -> <store>/qar
```
---

# What makes pnpm great?

```plaintext

```

ğŸˆ DISK SPACE EFFICIENCY ğŸˆ

âš¡ï¸ SPEED âš¡ï¸

```plaintext


```

| action  | cache | lockfile | node_modules| npm | pnpm | Yarn |
| ---     | ---   | ---      | ---         | --- | ---  | ---  |
| install |       |          |             | 33.9s | 8.1s | 7.1s |
| install | âœ”     | âœ”        | âœ”           | 1.5s | 1s | 5.1s |
| install | âœ”     | âœ”        |             | 7.9s | 2.6s | 5.3s |
| install | âœ”     |          |             | 12.9s | 5.8s | 7.2s |
| install |       | âœ”        |             | 12s | 5.3s | 5.4s |
| install | âœ”     |          | âœ”           | 1.7s | 2.4s | 6.9s |
| install |       | âœ”        | âœ”           | 1.4s | 1.1s | 5.1s |
| install |       |          | âœ”           | 1.8s | 5.4s | 6.8s |
| update  | n/a | n/a | n/a | 6.8s | 3.8s | 5.6s | 3s |

---

# Demistifying pnpm

The End ğŸ”®

# Q&A

- QUESTIONS????????
